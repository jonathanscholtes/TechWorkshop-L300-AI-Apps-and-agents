
name: Run Customer Loyalty Agent Initializer

on:
  push:
    paths:
      - "src/app/agents/customerLoyaltyAgent_initializer.py"
      - "src/prompts/CustomerLoyaltyAgentPrompt.txt"
      - "src/app/tools/discountLogic.py"
  pull_request:
    paths:
      - "src/app/agents/customerLoyaltyAgent_initializer.py"
      - "src/prompts/CustomerLoyaltyAgentPrompt.txt"
      - "src/app/tools/discountLogic.py"

jobs:
  run-customer-loyalty-agent:
    runs-on: ubuntu-latest

    steps:
      # 1. Checkout code
      - name: Checkout repository
        uses: actions/checkout@v4

      # 2. Set up Python
      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip" # Enables pip cache across runs

      # 3. Show Python info
      - name: Show Python info
        run: |
          set -euo pipefail
          python --version
          python -c "import sys; print(sys.version); import site; print(site.getsitepackages())"

      # 4. Install system dependencies
      - name: Install system dependencies for builds
        run: |
          set -euo pipefail
          sudo apt-get update
          sudo apt-get install -y unixodbc-dev build-essential

      # 5. Install Python dependencies
      - name: Upgrade pip and install dependencies
        run: |
          set -euo pipefail
          python -m pip install --upgrade pip
          python -m pip install \
            requests==2.32.5 \
            python-dotenv==1.1.1 \
            openai==2.3.0 \
            pandas==2.3.3 \
            azure-cosmos==4.9.0 \
            semantic-kernel==1.37.0 \
            azure-ai-projects==1.1.0b4 \
            azure-ai-agents==1.2.0b5 \
            azure-identity==1.25.1 \
            pyodbc==5.2.0 \
            sqlalchemy==2.0.44 \
            azure-monitor-opentelemetry==1.8.1

      # 6. Populate .env from GitHub Secrets
      - name: Populate .env from secrets
        env:
          ENV_FILE_CONTENT: ${{ secrets.ENV }}
        run: |
          set -euo pipefail
          # Write the secrets as-is to .env (supports multiline and special chars like ';')
          printf '%s' "$ENV_FILE_CONTENT" > .env
          # Verify file exists and is non-empty without leaking contents
          test -s .env

      # 7. Run the Customer Loyalty Agent Initializer
      - name: Run Customer Loyalty Agent Initializer (Service Principal Auth)
        env:
          AZURE_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }}
          AZURE_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}
          AZURE_CLIENT_SECRET: ${{ secrets.AZURE_CLIENT_SECRET }}
          AZURE_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
        run: |
          set -euo pipefail
          echo "Starting Customer Loyalty Agent Initializer..."
          ls -al src/app/agents || { echo "Directory missing"; exit 1; }
          python src/app/agents/customerLoyaltyAgent_initializer.py

